<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coze Chat</title>
    <style>
        canvas {
            border: 1px solid #000;
            cursor: crosshair;
            background-color: #FFFFFF;
        }
    </style>
</head>
<body>
    <h1>æ¶‚é¸¦æ¿ğŸ˜”</h1>
    <canvas id="drawingCanvas" width="800" height="600"></canvas>
    <input type="text" id="userQuery" placeholder="User Input">
    <button id="saveImage">ä¸Šä¼ </button>

    <p id="responseDisplay"></p>
    <script>
        document.getElementById('saveImage').onclick = function() {
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');

            // åˆ›å»ºä¸€ä¸ªæ–°çš„canvasï¼Œç¡®ä¿ä¸ä¼šå½±å“åŸå§‹canvasä¸Šçš„ç»˜åˆ¶
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            // è®¾ç½®ä¸´æ—¶canvasçš„å°ºå¯¸å’ŒåŸå§‹canvasç›¸åŒ
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;

            // å¡«å……ç™½è‰²èƒŒæ™¯
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            // å°†åŸå§‹canvasçš„å†…å®¹ç»˜åˆ¶åˆ°ä¸´æ—¶canvasä¸Š
            tempCtx.drawImage(canvas, 0, 0);

            // å°†ä¸´æ—¶canvasä¿å­˜ä¸ºå›¾ç‰‡
            const image = tempCanvas.toDataURL('image/png');
            const base64Image = image.split(',')[1];
            console.log(image)

            const query = document.getElementById('userQuery').value;

            fetch('/getUrl/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query, img_base64: base64Image }),
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('responseDisplay').textContent = data.response;
            })
            .catch(error => {
                console.error('Error:', error);
            });

        }
    </script>

    <script>
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');

        // åˆå§‹åŒ–ç»˜å›¾çŠ¶æ€
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return; // å¦‚æœæœªæŒ‰ä¸‹é¼ æ ‡ï¼Œåˆ™ä¸è¿›è¡Œç»˜å›¾

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        });

        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        canvas.addEventListener('mouseout', () => {
            isDrawing = false;
        });

        // è®¾ç½®ç»˜å›¾æ ·å¼
        ctx.strokeStyle = '#1a1a1a'; // çº¢è‰²çº¿æ¡
        ctx.lineWidth = 3; // çº¿æ¡å®½åº¦
    </script>
</body>
</html>